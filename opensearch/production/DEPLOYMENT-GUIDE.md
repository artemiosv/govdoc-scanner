# Phase 1 Production Deployment Guide

## ðŸš¨ CRITICAL SECURITY WARNING

**Demo certificates are automatically generated by this setup and should NEVER be used in production!**

- Demo certificates are created for initial testing only
- Replace ALL certificates with proper CA-signed certificates before production use
- Private keys are generated locally and must be kept secure
- See `certs/README.md` for certificate replacement instructions

## Quick Start - Deploy Production OpenSearch

This guide walks you through deploying the production OpenSearch cluster for GovDoc Scanner.

### Prerequisites Check

```bash
# Verify system requirements
free -h                    # Should show ~16GB RAM
nproc                     # Should show 4+ CPU cores
df -h                     # Should have 200GB+ free space
docker --version          # Docker 20.10+
docker-compose --version  # Docker Compose 1.29+
```

### Step 1: Security Setup (5 minutes)

```bash
# Navigate to production directory
cd opensearch/production

# Generate security configuration
./scripts/setup-security.sh

# This creates:
# - Strong passwords for all users
# - Security configuration files
# - Demo certificates (replace in production!)
# - .env file with credentials
```

**IMPORTANT**: Save the passwords displayed at the end!

### Step 2: Start the Cluster (3 minutes)

```bash
# Load environment variables
source .env

# Start production cluster
docker-compose -f docker-compose.prod.yml up -d

# Check status
docker-compose -f docker-compose.prod.yml ps

# Wait for cluster to be ready (takes 2-3 minutes)
./scripts/health-check.sh
```

### Step 3: Initialize Cluster

```bash
# Initialize indices and templates
./scripts/initialize-cluster.sh

# This sets up:
# - Index templates
# - Initial indices with aliases
# - Backup repository
# - Tests application user permissions
```

## Verification & Testing

### Verify Installation

```bash
# Check cluster health
curl -k -u admin:$OPENSEARCH_PROD_ADMIN_PASSWORD https://localhost:9200/_cluster/health

# Expected response: {"status":"green",...}

# Check indices
curl -k -u admin:$OPENSEARCH_PROD_ADMIN_PASSWORD https://localhost:9200/_cat/indices

# Access Dashboards
# Open http://localhost:5601
# Login with admin / $OPENSEARCH_PROD_ADMIN_PASSWORD
```

### Test Data Ingestion

```bash
# Update your main .env file with production credentials
cd ../..  # Back to project root

# Add to .env:
OPENSEARCH_PUSH=true
OPENSEARCH_URL=https://localhost:9200
OPENSEARCH_USERNAME=govdoc_ingest
OPENSEARCH_PASSWORD=<govdoc_password_from_.env>
OPENSEARCH_INDEX=govdoc-companies-write
OPENSEARCH_INSECURE=true

# Test ingestion
npm start govdoc -- --input ./companies.gds --push

# Verify data
curl -k -u govdoc_ingest:<password> https://localhost:9200/govdoc-companies/_count
```

## Production Configuration Files

### Generated Files Structure

```
opensearch/production/
â”œâ”€â”€ docker-compose.prod.yml    # Production Docker Compose
â”œâ”€â”€ .env                       # Environment variables (KEEP SECURE!)
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ opensearch.yml         # Main OpenSearch config
â”‚   â”œâ”€â”€ jvm.options           # JVM settings (8GB heap)
â”‚   â”œâ”€â”€ internal_users.yml    # User definitions
â”‚   â”œâ”€â”€ roles.yml             # Role definitions
â”‚   â””â”€â”€ roles_mapping.yml     # User-role mappings
â”œâ”€â”€ certs/                    # SSL certificates (generated by scripts)
â”‚   â”œâ”€â”€ README.md             # Certificate management guide
â”‚   â”œâ”€â”€ root-ca.pem           # Generated demo certificates
â”‚   â”œâ”€â”€ node.pem              # (REPLACE WITH PROPER CERTS IN PRODUCTION!)
â”‚   â””â”€â”€ node-key.pem
â””â”€â”€ scripts/
    â”œâ”€â”€ setup-security.sh     # Security initialization
    â”œâ”€â”€ initialize-cluster.sh # Cluster setup
    â”œâ”€â”€ health-check.sh       # Health monitoring
    â””â”€â”€ backup.sh             # Backup management
```

## Daily Operations

### Health Monitoring

````bash
# Run health check
cd opensearch/production
./scripts/health-check.sh

### Backup Management

```bash
# Create manual backup
./scripts/backup.sh

# List existing backups
./scripts/backup.sh --list-only

### Log Monitoring

```bash
# View OpenSearch logs
docker logs govdoc-opensearch-production -f

# View container stats
docker stats govdoc-opensearch-production
````

## Security Configuration Details

### User Accounts Created

- **admin**: Full cluster administration
- **govdoc_ingest**: Application data ingestion (minimal permissions)
- **kibanaserver**: Dashboards communication

## Resource Usage

### Memory Configuration

- **JVM Heap**: 8GB (50% of 16GB system)
- **Container Limit**: ~12GB total
- **System Reserve**: ~4GB for OS

### Storage

- **Data Volume**: `opensearch-prod-data`
- **Logs Volume**: `opensearch-prod-logs`
- **Backup Volume**: `opensearch-prod-backup`

### Ports

- **9200**: REST API (HTTPS)
- **9300**: Transport (for future clustering)
- **5601**: Dashboards UI
